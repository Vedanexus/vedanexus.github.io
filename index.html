<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dark Forest: The Signal</title>

<style>
html,body{margin:0;padding:0;overflow:hidden}
body{background:url("bg.jpg") center/cover fixed no-repeat}
body::after{
  content:"";position:fixed;inset:0;
  background:radial-gradient(circle,rgba(0,0,0,.15),rgba(0,0,0,.85));
  pointer-events:none;
}
canvas{position:fixed;inset:0}
</style>
</head>

<body>
<canvas id="game"></canvas>

<audio id="music" src="music.mp3" loop playsinline></audio>
<audio id="hit" src="hit.mp3" playsinline></audio>

<script>
/* ===== CORE ===== */
const c=document.getElementById("game"),ctx=c.getContext("2d");
let W,H,shake=0;
function resize(){W=c.width=innerWidth;H=c.height=innerHeight}
addEventListener("resize",resize);resize();

/* ===== ASSETS ===== */
const heroImg=new Image(); heroImg.src="hero.png";
const enemyImg=new Image(); enemyImg.src="enemy.png";
const bossImg=new Image();  bossImg.src="boss.png";

/* ===== AUDIO ===== */
const music=document.getElementById("music");
const hit=document.getElementById("hit");
let musicStarted=false;
function startMusic(){
 if(musicStarted) return;
 music.muted=true;
 music.play().then(()=>{
   setTimeout(()=>{music.muted=false;music.volume=.35},300);
   musicStarted=true;
 });
}

/* ===== SAVE ===== */
let highScore=Number(localStorage.getItem("highScore")||0);

/* ===== STATE ===== */
let player={x:W/2-32,y:H-150,w:64,h:96,shield:false};
let enemies=[],bullets=[],bossBullets=[];
let boss=null;
let score=0,level=1,gameOver=false;
let speed=3,drag=false;
let storyTimer=200;

/* ===== INPUT ===== */
addEventListener("pointerdown",e=>{
 startMusic();
 if(gameOver){reset();return;}
 drag=true;
 player.x=e.clientX-player.w/2;
 shoot();
});
addEventListener("pointermove",e=>{if(drag)player.x=e.clientX-player.w/2});
addEventListener("pointerup",()=>drag=false);

/* ===== SHOOT ===== */
function shoot(){
 bullets.push({x:player.x+30,y:player.y,w:6,h:14,v:10});
}

/* ===== SPAWN ===== */
function spawnEnemy(){
 enemies.push({x:Math.random()*(W-70),y:-100,w:70,h:90});
}
function spawnBoss(){
 boss={
  x:W/2-120,y:-240,w:240,h:240,
  hp:40,phase:1,fireDelay:60
 };
 shake=40; vibrate(200);
}

/* ===== UPDATE ===== */
function update(){
 if(gameOver) return;
 if(storyTimer>0){storyTimer--;return;}

 level = Math.floor(score/800)+1;
 speed = 3 + level*0.4;

 if(!boss && score>1200*level) spawnBoss();
 if(!boss && Math.random()<.03) spawnEnemy();

 enemies.forEach(e=>e.y+=speed);
 bullets.forEach(b=>b.y-=b.v);
 bossBullets.forEach(b=>b.y+=b.v);

 if(boss && boss.y<60) boss.y+=0.5;

 // Boss phase change
 if(boss && boss.hp<20 && boss.phase===1){
  boss.phase=2;
  boss.fireDelay=30;
  shake=30;
 }

 // Boss fire
 if(boss){
  boss.fireDelay--;
  if(boss.fireDelay<=0){
   bossBullets.push({
    x:boss.x+boss.w/2-6,
    y:boss.y+boss.h,
    w:12,h:18,v: boss.phase===2?8:5
   });
   boss.fireDelay = boss.phase===2?25:45;
  }
 }

 // Bullet hits
 bullets.forEach((b,bi)=>{
  enemies.forEach((e,ei)=>{
   if(hitBox(b,e)){
    enemies.splice(ei,1);
    bullets.splice(bi,1);
    score+=50;
   }
  });
  if(boss && hitBox(b,boss)){
   bullets.splice(bi,1);
   boss.hp--;
   shake=10;
   if(boss.hp<=0){
    boss=null;
    score+=1000;
   }
  }
 });

 // Boss bullets hit player
 bossBullets.forEach(b=>{
  if(hitBox(player,b)){
   if(player.shield){player.shield=false;}
   else die();
  }
 });

 enemies.forEach(e=>{
  if(hitBox(player,e)) die();
 });

 enemies=enemies.filter(e=>e.y<H+200);
 bullets=bullets.filter(b=>b.y>-50);
 bossBullets=bossBullets.filter(b=>b.y<H+50);

 score++;
}

/* ===== DRAW ===== */
function draw(){
 ctx.setTransform(1,0,0,1,0,0);
 if(shake>0){ctx.translate(Math.random()*shake,Math.random()*shake);shake--}
 ctx.clearRect(0,0,W,H);

 if(storyTimer>0){
  ctx.fillStyle="white";
  ctx.font="22px system-ui";
  ctx.fillText("The forest remembers.",W/2-110,H/2);
  return;
 }

 // Bullets
 ctx.fillStyle="rgba(180,220,255,.9)";
 bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

 // Boss bullets
 ctx.fillStyle="orange";
 bossBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

 // Enemies
 enemies.forEach(e=>{
  ctx.shadowBlur=25; ctx.shadowColor="red";
  ctx.drawImage(enemyImg,e.x,e.y,e.w,e.h);
 });

 // Boss
 if(boss){
  ctx.shadowBlur=40;
  ctx.shadowColor=boss.phase===2?"red":"purple";
  ctx.drawImage(bossImg,boss.x,boss.y,boss.w,boss.h);
  ctx.shadowBlur=0;
  ctx.fillStyle="red";
  ctx.fillRect(boss.x,boss.y-10,boss.w*(boss.hp/40),6);
 }

 // Hero
 ctx.shadowBlur=25; ctx.shadowColor="white";
 ctx.drawImage(heroImg,player.x,player.y,player.w,player.h);
 ctx.shadowBlur=0;

 // UI
 ctx.fillStyle="white";
 ctx.font="16px system-ui";
 ctx.fillText("Score: "+score,12,22);
 ctx.fillText("High: "+highScore,12,42);
 ctx.fillText("Level: "+level,12,62);

 if(gameOver){
  ctx.fillText("YOU DIED",W/2-40,H/2);
  ctx.fillText("TAP TO RESTART",W/2-70,H/2+22);
 }
}

/* ===== HELPERS ===== */
function hitBox(a,b){
 return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}
function die(){
 hit.currentTime=0; hit.play();
 if(score>highScore){
  highScore=score;
  localStorage.setItem("highScore",highScore);
 }
 vibrate(200);
 shake=40;
 gameOver=true;
}
function vibrate(ms){
 if(navigator.vibrate) navigator.vibrate(ms);
}
function reset(){
 enemies=[];bullets=[];bossBullets=[];
 boss=null;score=0;level=1;
 gameOver=false;storyTimer=120;
}

/* ===== LOOP ===== */
(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html>
