<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dark Forest: The Signal</title>

<style>
html,body{margin:0;padding:0;overflow:hidden}
body{background:url("bg.jpg") center/cover fixed no-repeat}
body::after{
  content:"";position:fixed;inset:0;
  background:radial-gradient(circle,rgba(0,0,0,.2),rgba(0,0,0,.9));
  pointer-events:none;
}
canvas{position:fixed;inset:0}
</style>
</head>

<body>
<canvas id="game"></canvas>

<audio id="music" src="music.mp3" loop playsinline></audio>
<audio id="bossMusic" src="boss-music.mp3" loop playsinline></audio>
<audio id="hit" src="hit.mp3" playsinline></audio>

<script>
/* ===== CORE ===== */
const c=document.getElementById("game"),ctx=c.getContext("2d");
let W,H,shake=0;
function resize(){W=c.width=innerWidth;H=c.height=innerHeight}
addEventListener("resize",resize);resize();

/* ===== ASSETS ===== */
const heroImg=new Image(); heroImg.src="hero.png";
const enemyImg=new Image(); enemyImg.src="enemy.png";
const bossImg=new Image();  bossImg.src="boss.png";

/* ===== AUDIO ===== */
const music=document.getElementById("music");
const bossMusic=document.getElementById("bossMusic");
const hit=document.getElementById("hit");
let musicStarted=false;

function startMusic(){
 if(musicStarted) return;
 music.muted=true;
 music.play().then(()=>{
   setTimeout(()=>{music.muted=false;music.volume=.35},300);
   musicStarted=true;
 });
}
function startBossMusic(){
 music.pause();
 bossMusic.currentTime=0;
 bossMusic.volume=0.5;
 bossMusic.play();
}
function stopBossMusic(){
 bossMusic.pause();
 music.play();
}

/* ===== STATE ===== */
let player={x:W/2-32,y:H-150,w:64,h:96};
let enemies=[],bullets=[],bossBullets=[];
let boss=null;
let bossIndex=1;
let score=0,level=1,speed=3;
let gameOver=false;
let storyTimer=0;
let introTimer=0;

/* ===== INPUT ===== */
addEventListener("pointerdown",e=>{
 startMusic();
 if(gameOver){reset();return;}
 player.x=e.clientX-player.w/2;
 shoot();
});

/* ===== SHOOT ===== */
function shoot(){
 bullets.push({x:player.x+30,y:player.y,w:6,h:14,v:10});
}

/* ===== SPAWN ===== */
function spawnEnemy(){
 enemies.push({x:Math.random()*(W-70),y:-100,w:70,h:90});
}
function spawnBoss(){
 boss={
  x:W/2-120,y:60,w:240,h:240,
  hp:40+bossIndex*10,
  dir:1,fireTick:0
 };
 introTimer=50;      // cinematic freeze
 shake=40;
 startBossMusic();
}

/* ===== UPDATE ===== */
function update(){
 if(gameOver) return;

 level=Math.floor(score/800)+1;
 speed=3+level*0.3;

 if(!boss && level>=bossIndex*3){
   spawnBoss();
 }

 if(introTimer>0){
   introTimer--;
   return;
 }

 if(!boss && Math.random()<.03) spawnEnemy();

 enemies.forEach(e=>e.y+=speed);
 bullets.forEach(b=>b.y-=b.v);

 /* ===== BOSS BEHAVIOUR ===== */
 if(boss){
  boss.x+=boss.dir*(bossIndex>=3?3:2);
  if(boss.x<20||boss.x+boss.w>W-20) boss.dir*=-1;

  boss.fireTick++;
  if(boss.fireTick> (bossIndex>=3?25:45)){
    boss.fireTick=0;

    // patterns
    if(bossIndex===1){
      bossBullets.push({x:boss.x+boss.w/2,y:boss.y+boss.h,w:10,h:16,v:5});
    }
    else if(bossIndex===2){
      bossBullets.push({x:boss.x+60,y:boss.y+boss.h,w:10,h:16,v:6});
      bossBullets.push({x:boss.x+160,y:boss.y+boss.h,w:10,h:16,v:6});
    }
    else{
      for(let i=-1;i<=1;i++){
        bossBullets.push({
          x:boss.x+boss.w/2+i*20,
          y:boss.y+boss.h,
          w:10,h:16,v:7
        });
      }
    }
  }
 }

 bossBullets.forEach(b=>b.y+=b.v);

 /* ===== COLLISIONS ===== */
 bullets.forEach((b,bi)=>{
  enemies.forEach((e,ei)=>{
   if(hit(b,e)){
    enemies.splice(ei,1);
    bullets.splice(bi,1);
    score+=50;
   }
  });
  if(boss && hit(b,boss)){
   bullets.splice(bi,1);
   boss.hp--;
   shake=8;
   if(boss.hp<=0){
     boss=null;
     bossIndex++;
     stopBossMusic();
     score+=1500;
   }
  }
 });

 enemies=enemies.filter(e=>e.y<H+200);
 bullets=bullets.filter(b=>b.y>-50);
 bossBullets=bossBullets.filter(b=>b.y<H+50);

 score++;
}

/* ===== DRAW ===== */
function draw(){
 ctx.setTransform(1,0,0,1,0,0);
 if(shake>0){ctx.translate(Math.random()*shake,Math.random()*shake);shake--}
 ctx.clearRect(0,0,W,H);

 if(introTimer>0){
  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,W,H);
  ctx.fillStyle="red";
  ctx.font="28px system-ui";
  ctx.fillText("⚠ WARNING ⚠",W/2-80,H/2-10);
  ctx.fillText("SOMETHING IS COMING",W/2-140,H/2+25);
  return;
 }

 bullets.forEach(b=>{
  ctx.fillStyle="white";
  ctx.fillRect(b.x,b.y,b.w,b.h);
 });

 bossBullets.forEach(b=>{
  ctx.fillStyle="orange";
  ctx.fillRect(b.x,b.y,b.w,b.h);
 });

 enemies.forEach(e=>{
  ctx.shadowBlur=20;ctx.shadowColor="red";
  ctx.drawImage(enemyImg,e.x,e.y,e.w,e.h);
 });

 if(boss){
  ctx.shadowBlur=40;
  ctx.shadowColor=bossIndex>=3?"red":"purple";
  ctx.drawImage(bossImg,boss.x,boss.y,boss.w,boss.h);
  ctx.shadowBlur=0;
  ctx.fillStyle="red";
  ctx.fillRect(boss.x,boss.y-10,boss.w*(boss.hp/(40+bossIndex*10)),6);
 }

 ctx.shadowBlur=25;ctx.shadowColor="white";
 ctx.drawImage(heroImg,player.x,player.y,player.w,player.h);
 ctx.shadowBlur=0;

 ctx.fillStyle="white";
 ctx.font="16px system-ui";
 ctx.fillText("Score: "+score,12,22);
 ctx.fillText("Level: "+level,12,42);
}

/* ===== HELPERS ===== */
function hit(a,b){
 return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}
function reset(){
 enemies=[];bullets=[];bossBullets=[];
 boss=null;bossIndex=1;
 score=0;level=1;
 gameOver=false;
}

/* ===== LOOP ===== */
(function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
})();
</script>
</body>
</html>
