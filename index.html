<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dark Forest â€“ Final Mission</title>

<style>
html,body{margin:0;padding:0;overflow:hidden}
body{background:#000}
canvas{display:block}
</style>
</head>

<body>
<canvas id="game"></canvas>

<script>
const c=document.getElementById("game"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener("resize",resize);resize();

/* ASSETS */
const heroImg=new Image(); heroImg.src="hero.png";
const enemyImg=new Image(); enemyImg.src="enemy.png";
const bossImg=new Image();  bossImg.src="boss.png";

/* STATE */
let level=1;
let player, bullets, enemies, boss;
let gameState="start"; // start | play | win | over

function reset(){
  player={x:c.width/2-24,y:c.height-90,w:48,h:48};
  bullets=[];
  enemies=[];
  boss=null;
}
reset();

/* INPUT */
addEventListener("pointerdown",e=>{
  if(gameState==="start"){
    gameState="play";
    return;
  }
  if(gameState==="win"||gameState==="over"){
    level=1;
    gameState="start";
    reset();
    return;
  }
  bullets.push({
    x:player.x+22,y:player.y,w:4,h:12,v:10
  });
});
addEventListener("pointermove",e=>{
  if(gameState==="play"){
    player.x=e.clientX-player.w/2;
  }
});

/* COLLISION */
function hit(a,b){
  return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}

/* UPDATE */
function update(){
  if(gameState!=="play") return;

  bullets.forEach(b=>b.y-=b.v);

  // LEVEL 1 & 2 ENEMIES
  if(level<=2 && Math.random()<0.02){
    enemies.push({
      x:Math.random()*(c.width-48),
      y:-50,w:48,h:48,v:2+level
    });
  }

  enemies.forEach(e=>e.y+=e.v);

  // BULLET â†’ ENEMY
  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(hit(b,e)){
        bullets.splice(bi,1);
        enemies.splice(ei,1);
      }
    });
  });

  // LEVEL PROGRESSION
  if(level===1 && enemies.length===0){
    level=2;
  }
  if(level===2 && enemies.length===0){
    level=3;
    boss={x:c.width/2-80,y:60,w:160,h:160,hp:20,dir:1};
  }

  // FINAL BOSS
  if(level===3 && boss){
    boss.x+=boss.dir*2;
    if(boss.x<20||boss.x+boss.w>c.width-20) boss.dir*=-1;

    bullets.forEach((b,bi)=>{
      if(hit(b,boss)){
        bullets.splice(bi,1);
        boss.hp--;
        if(boss.hp<=0){
          boss=null;
          gameState="win";
        }
      }
    });
  }

  bullets=bullets.filter(b=>b.y>-20);
  enemies=enemies.filter(e=>e.y<c.height+60);
}

/* DRAW */
function draw(){
  ctx.clearRect(0,0,c.width,c.height);

  if(gameState==="start"){
    ctx.fillStyle="white";
    ctx.font="24px system-ui";
    ctx.fillText("FINAL MISSION",c.width/2-90,c.height/2-10);
    ctx.font="16px system-ui";
    ctx.fillText("Tap to Start",c.width/2-50,c.height/2+20);
    return;
  }

  if(gameState==="win"){
    ctx.fillStyle="white";
    ctx.font="26px system-ui";
    ctx.fillText("YOU WIN ðŸŽ‰",c.width/2-80,c.height/2);
    ctx.font="16px system-ui";
    ctx.fillText("Tap to Play Again",c.width/2-70,c.height/2+30);
    return;
  }

  ctx.drawImage(heroImg,player.x,player.y,player.w,player.h);

  bullets.forEach(b=>{
    ctx.fillStyle="cyan";
    ctx.fillRect(b.x,b.y,b.w,b.h);
  });

  enemies.forEach(e=>{
    ctx.drawImage(enemyImg,e.x,e.y,e.w,e.h);
  });

  if(boss){
    ctx.drawImage(bossImg,boss.x,boss.y,boss.w,boss.h);
    ctx.fillStyle="red";
    ctx.fillRect(boss.x,boss.y-10,boss.w*(boss.hp/20),6);
  }

  ctx.fillStyle="white";
  ctx.fillText("Level: "+level,12,20);
}

/* LOOP */
(function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
