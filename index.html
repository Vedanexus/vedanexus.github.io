<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dark Forest: The Signal</title>

<style>
html,body{margin:0;padding:0;overflow:hidden}
body{background:url("bg.jpg") center/cover fixed no-repeat}
body::after{
 content:"";position:fixed;inset:0;
 background:radial-gradient(circle,rgba(0,0,0,.15),rgba(0,0,0,.85));
 pointer-events:none;
}
canvas{position:fixed;inset:0}
</style>
</head>

<body>
<canvas id="game"></canvas>

<audio id="music" src="music.mp3" loop playsinline></audio>
<audio id="hit" src="hit.mp3" playsinline></audio>

<script>
const c=document.getElementById("game"),x=c.getContext("2d");
let W,H,shake=0,t=0;
function resize(){W=c.width=innerWidth;H=c.height=innerHeight}
addEventListener("resize",resize);resize();

/* ASSETS */
const hero=new Image(); hero.src="hero.png";
const enemyImg=new Image(); enemyImg.src="enemy.png";
const music=document.getElementById("music");
const hit=document.getElementById("hit");

/* STATE */
let player={x:W/2-32,y:H-150,w:64,h:96,shield:false};
let enemies=[],bullets=[],powerups=[];
let boss=null;
let score=0,speed=3,gameOver=false;
let musicStarted=false,drag=false;
let rapidFire=0;
let storyTimer=240;

/* AUDIO */
function startMusic(){
 if(musicStarted) return;
 music.muted=true;
 music.play().then(()=>{
   setTimeout(()=>{music.muted=false;music.volume=.35},300);
   musicStarted=true;
 });
}

/* INPUT */
addEventListener("pointerdown",e=>{
 startMusic();
 if(gameOver){reset();return;}
 drag=true;
 player.x=e.clientX-player.w/2;
 shoot();
});
addEventListener("pointermove",e=>{if(drag)player.x=e.clientX-player.w/2});
addEventListener("pointerup",()=>drag=false);

/* SHOOT */
function shoot(){
 bullets.push({x:player.x+player.w/2-4,y:player.y,w:8,h:16,v:rapidFire?14:10});
}

/* SPAWN */
function spawnEnemy(){
 enemies.push({x:Math.random()*(W-70),y:-100,w:70,h:90});
}

/* BOSS */
function spawnBoss(){
 boss={x:W/2,y:-120,r:90,hp:30};
 shake=40; vibrate(200);
}

/* UPDATE */
function update(){
 t++;
 if(gameOver) return;

 if(storyTimer>0){storyTimer--;return;}

 if(!boss && score>1500) spawnBoss();

 if(Math.random()<.03 && !boss) spawnEnemy();

 enemies.forEach(e=>e.y+=speed);
 bullets.forEach(b=>b.y-=b.v);
 if(boss && boss.y<120) boss.y+=0.6;

 bullets.forEach((b,bi)=>{
  enemies.forEach((e,ei)=>{
   if(hitBox(b,e)){
    enemies.splice(ei,1);bullets.splice(bi,1);
    score+=50;vibrate(40);
   }
  });
  if(boss && circleHit(b,boss)){
   bullets.splice(bi,1);
   boss.hp--; shake=10; vibrate(80);
   if(boss.hp<=0){boss=null;score+=1200;}
  }
 });

 enemies.forEach(e=>{
  if(hitBox(player,e)){
   if(player.shield){player.shield=false;e.y=H+200;}
   else die();
  }
 });

 if(boss && circleHit(player,boss)){
  if(player.shield){player.shield=false;}
  else die();
 }

 enemies=enemies.filter(e=>e.y<H+200);
 bullets=bullets.filter(b=>b.y>-50);

 speed+=.002; score++; if(rapidFire>0) rapidFire--;
}

/* DRAW */
function draw(){
 x.setTransform(1,0,0,1,0,0);
 if(shake>0){x.translate(Math.random()*shake,Math.random()*shake);shake--}
 x.clearRect(0,0,W,H);

 if(storyTimer>0){
  x.fillStyle="white";x.font="22px system-ui";
  x.fillText("The forest remembers.",W/2-110,H/2-10);
  x.fillText("You should not be here.",W/2-130,H/2+20);
  return;
 }

 // HERO SPOTLIGHT
 let g=x.createRadialGradient(player.x+32,player.y+96,10,player.x+32,player.y+96,140);
 g.addColorStop(0,"rgba(255,255,255,.18)");
 g.addColorStop(1,"rgba(255,255,255,0)");
 x.fillStyle=g;x.beginPath();
 x.arc(player.x+32,player.y+96,140,0,Math.PI*2);x.fill();

 // BULLETS
 x.fillStyle="rgba(180,220,255,.9)";
 bullets.forEach(b=>x.fillRect(b.x,b.y,b.w,b.h));

 // ENEMIES
 enemies.forEach(e=>{
  x.shadowBlur=30;x.shadowColor="red";
  x.drawImage(enemyImg,e.x,e.y,e.w,e.h);
 });

 // ðŸ§Ÿ ORGANIC BOSS (NOT A BOX)
 if(boss){
  x.save();
  x.translate(boss.x,boss.y);

  x.shadowBlur=60;
  x.shadowColor="rgba(180,0,255,.9)";
  x.fillStyle="rgba(90,0,120,.85)";

  x.beginPath();
  for(let i=0;i<8;i++){
   let ang=(Math.PI*2/8)*i;
   let rr=boss.r+Math.sin(t*0.1+i)*18;
   let px=Math.cos(ang)*rr;
   let py=Math.sin(ang)*rr;
   i===0?x.moveTo(px,py):x.lineTo(px,py);
  }
  x.closePath(); x.fill();

  // core
  x.shadowBlur=25;
  x.fillStyle="rgba(255,50,50,.9)";
  x.beginPath();
  x.arc(0,0,boss.r*0.35,0,Math.PI*2);
  x.fill();

  x.restore();

  // HP BAR
  x.fillStyle="red";
  x.fillRect(boss.x-boss.r,boss.y-boss.r-15,(boss.hp/30)*(boss.r*2),6);
 }

 // HERO
 x.shadowBlur=player.shield?35:25;
 x.shadowColor=player.shield?"cyan":"white";
 x.drawImage(hero,player.x,player.y,player.w,player.h);
 x.shadowBlur=0;

 // UI
 x.fillStyle="white";x.font="16px system-ui";
 x.fillText("Score: "+score,12,22);

 if(gameOver){
  x.fillText("THE FOREST TOOK YOU",W/2-120,H/2);
  x.fillText("TAP TO RETURN",W/2-80,H/2+24);
 }
}

/* HELPERS */
function hitBox(a,b){
 return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}
function circleHit(a,b){
 let cx=b.x,cy=b.y;
 let ax=a.x+a.w/2,ay=a.y+a.h/2;
 return Math.hypot(ax-cx,ay-cy)<b.r;
}
function die(){
 hit.currentTime=0;hit.play();
 vibrate(200);shake=50;gameOver=true;
}
function vibrate(ms){
 if(navigator.vibrate) navigator.vibrate(ms);
}
function reset(){
 enemies=[];bullets=[];
 boss=null;score=0;speed=3;
 gameOver=false;storyTimer=180;
 player.shield=false;rapidFire=0;
}

/* LOOP */
(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html>
